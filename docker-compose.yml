services:
  postgres:
    container_name: postgres
    image: docker.io/library/postgres:14
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - keycloak_network

  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:25.0.6
    user: "${UID:-1000}"
    volumes:
      - "./car-rental-realm.json:/opt/keycloak/data/import/car-rental-realm.json:Z"
    command:
      - start-dev
      - --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
    ports:
      - 7777:8080
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 60s
    networks:
      - keycloak_network

  reservation-postgres:
    image: postgres:14
    container_name: reservation-postgres
    environment:
      POSTGRES_DB: reservation
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d reservation"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - keycloak_network

  inventory-mysql:
    image: mysql:8.0
    container_name: inventory-mysql
    environment:
      MYSQL_DATABASE: inventory
      MYSQL_USER: user
      MYSQL_PASSWORD: pass
      MYSQL_ROOT_PASSWORD: rootpass
    command: 
      - --wait_timeout=28800
      - --interactive_timeout=28800
      - --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uuser", "-ppass"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - keycloak_network

  users-service:
    build:
      context: ./users-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: users-service
    environment:
      QUARKUS_OIDC_AUTH_SERVER_URL: http://keycloak:8080/realms/car-rental
      QUARKUS_OIDC_CLIENT_ID: users-service
      QUARKUS_OIDC_TOKEN_STATE_MANAGER_SPLIT_TOKENS: true
    ports:
      - "8080:8080"
    depends_on:
      keycloak:
        condition: service_healthy
    restart: on-failure
    networks:
      - keycloak_network

  reservation-service:
    build:
      context: ./reservation-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: reservation-service
    environment:
      QUARKUS_HTTP_PORT: 8081
      QUARKUS_SMALLRYE_GRAPHQL_CLIENT_INVENTORY_URL: http://inventory-service:8083/graphql
      QUARKUS_OIDC_AUTH_SERVER_URL: http://keycloak:8080/realms/car-rental
      QUARKUS_OIDC_CLIENT_ID: reservation-service
      QUARKUS_OIDC_TOKEN_STATE_MANAGER_SPLIT_TOKENS: true
      QUARKUS_DATASOURCE_USERNAME: user
      QUARKUS_DATASOURCE_PASSWORD: pass
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://reservation-postgres:5432/reservation
      QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION: drop-and-create
    ports:
      - "8081:8081"
    depends_on:
      keycloak:
        condition: service_healthy
      reservation-postgres:
        condition: service_healthy
      inventory-service:
        condition: service_healthy
    restart: on-failure
    networks:
      - keycloak_network

  inventory-service:
    build:
      context: ./inventory-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: inventory-service
    environment:
      QUARKUS_HTTP_PORT: 8083
      QUARKUS_DATASOURCE_USERNAME: user
      QUARKUS_DATASOURCE_PASSWORD: pass
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:mysql://inventory-mysql:3306/inventory
      QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION: drop-and-create
    ports:
      - "8083:8083"
    depends_on:
      inventory-mysql:
        condition: service_healthy
    restart: on-failure
    networks:
      - keycloak_network

networks:
  keycloak_network:
    driver: bridge
